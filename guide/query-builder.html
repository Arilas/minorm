<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query Builder | Minorm</title>
    <meta name="description" content="Minimal ORM for you node.js project">
    
    
    <link rel="preload" href="/minorm/assets/css/0.styles.dedcdfe4.css" as="style"><link rel="preload" href="/minorm/assets/js/app.202f15e2.js" as="script"><link rel="preload" href="/minorm/assets/js/8.c8257104.js" as="script"><link rel="prefetch" href="/minorm/assets/js/10.a876fc82.js"><link rel="prefetch" href="/minorm/assets/js/2.8c50750e.js"><link rel="prefetch" href="/minorm/assets/js/3.419c57b5.js"><link rel="prefetch" href="/minorm/assets/js/4.5832591d.js"><link rel="prefetch" href="/minorm/assets/js/5.8fb1b179.js"><link rel="prefetch" href="/minorm/assets/js/6.2decd2d4.js"><link rel="prefetch" href="/minorm/assets/js/7.dd473e3c.js"><link rel="prefetch" href="/minorm/assets/js/9.0dde5d86.js">
    <link rel="stylesheet" href="/minorm/assets/css/0.styles.dedcdfe4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/minorm/" class="home-link router-link-active"><!----> <span class="site-name">Minorm</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/minorm/guide/" class="nav-link router-link-active">Guide</a></div> <a href="https://github.com/Arilas/minorm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/minorm/guide/" class="nav-link router-link-active">Guide</a></div> <a href="https://github.com/Arilas/minorm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/minorm/guide/installation.html" class="sidebar-link">Installation</a></li><li><a href="/minorm/guide/getting-started.html" class="sidebar-link">Getting Started</a></li><li><a href="/minorm/guide/repositories.html" class="sidebar-link">Repositories</a></li><li><a href="/minorm/guide/models.html" class="sidebar-link">Models</a></li><li><a href="/minorm/guide/query-builder.html" class="active sidebar-link">Query Builder</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/minorm/guide/query-builder.html#select-queries" class="sidebar-link">SELECT queries</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/minorm/guide/query-builder.html#adding-conditions-to-where-part" class="sidebar-link">Adding conditions to WHERE part</a></li><li class="sidebar-sub-header"><a href="/minorm/guide/query-builder.html#using-join-clauses" class="sidebar-link">Using JOIN clauses</a></li><li class="sidebar-sub-header"><a href="/minorm/guide/query-builder.html#execution" class="sidebar-link">Execution</a></li></ul></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="query-builder"><a href="#query-builder" aria-hidden="true" class="header-anchor">#</a> Query Builder</h1> <p>Minorm uses extended version of <a href="https://github.com/hiddentao/squel" target="_blank" rel="noopener noreferrer">squel<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> Query Builder. You can check their docs to have more understanding of all functionality in it.</p> <h2 id="select-queries"><a href="#select-queries" aria-hidden="true" class="header-anchor">#</a> SELECT queries</h2> <p>To start a query you can use any of two options:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> query <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">startQuery</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">)</span>
</code></pre></div><p>or equally same version from a Manager:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> query <span class="token operator">=</span> manager
  <span class="token punctuation">.</span><span class="token function">startQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'post.*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'posts'</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">)</span>
</code></pre></div><p>Both are equal to the following SQL (to test purposes you can call <code>toString()</code> on query builder instance):</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> post<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> posts post
</code></pre></div><h3 id="adding-conditions-to-where-part"><a href="#adding-conditions-to-where-part" aria-hidden="true" class="header-anchor">#</a> Adding conditions to WHERE part</h3> <p>To add a condition you can use squel <code>where('some = ?', value)</code> functions or you can use <code>criteria()</code> function provided by minorm. For example lets add condition that status is either of ACTIVE or DRAFT, and creator_id is 5.</p> <div class="language-js extra-class"><pre class="language-js"><code>query<span class="token punctuation">.</span><span class="token function">criteria</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'post.status'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    $<span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'ACTIVE'</span><span class="token punctuation">,</span> <span class="token string">'DRAFT'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'post.creator_id'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Which in result will have following SQL:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> post<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> posts post <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span>creator_id <span class="token operator">=</span> ?<span class="token punctuation">)</span>
</code></pre></div><h3 id="using-join-clauses"><a href="#using-join-clauses" aria-hidden="true" class="header-anchor">#</a> Using JOIN clauses</h3> <p>To add <code>INNER JOIN</code> you can use squel <code>join('tableToJoin', 'joinedTableAlias', 'alias.someField = joinedTableAlias.id')</code> or you can minorm helper <code>include('alias', 'someField')</code> which is the equivalent. Minorm know all relations in your database so it can use it to help you fetch information.</p> <p>For example let's add reference to our post creator:</p> <div class="language-js extra-class"><pre class="language-js"><code>query<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'creator.*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">include</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'creator_id'</span><span class="token punctuation">,</span> <span class="token string">'creator'</span><span class="token punctuation">)</span>
</code></pre></div><p>The third parameter is optional and by default it's uses your column name with removed <code>_id</code> part. So we can change it to:</p> <div class="language-js extra-class"><pre class="language-js"><code>query<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'creator.*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">include</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'creator_id'</span><span class="token punctuation">)</span>
</code></pre></div><p>This is an equivalent of squel:</p> <div class="language-js extra-class"><pre class="language-js"><code>query
  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'creator.*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token string">'creator'</span><span class="token punctuation">,</span> <span class="token string">'post.creator_id = creator.id'</span><span class="token punctuation">)</span>
</code></pre></div><p>All examples will lead to the following SQL:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> post<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> creator<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> posts post <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> users creator <span class="token keyword">ON</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span>creator_id <span class="token operator">=</span> creator<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span>creator_id <span class="token operator">=</span> ?<span class="token punctuation">)</span>
</code></pre></div><p>In case that you need <code>LEFT JOIN</code> you can use <code>tryInclude()</code> helper with is equivalent of <code>left_join()</code>.</p> <p>For example creator may have an avatar and if it's exists in database we need to receive it. Let's add it to our query:</p> <div class="language-js extra-class"><pre class="language-js"><code>query<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'avatar.*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryInclude</span><span class="token punctuation">(</span><span class="token string">'creator'</span><span class="token punctuation">,</span> <span class="token string">'avatar_id'</span><span class="token punctuation">)</span>
</code></pre></div><p><code>tryInclude()</code> also can receive third parameter to make an alias</p> <p>This is an equivalent of squel:</p> <div class="language-js extra-class"><pre class="language-js"><code>query
  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">'avatar.*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">left_join</span><span class="token punctuation">(</span><span class="token string">'avatars'</span><span class="token punctuation">,</span> <span class="token string">'avatar'</span><span class="token punctuation">,</span> <span class="token string">'creator.avatar_id = avatar.id'</span><span class="token punctuation">)</span>
</code></pre></div><p>All examples will lead to the following SQL:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> post<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> creator<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> posts post
  <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> users creator <span class="token keyword">ON</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span>creator_id <span class="token operator">=</span> creator<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> avatars avatar <span class="token keyword">ON</span> <span class="token punctuation">(</span>creator<span class="token punctuation">.</span>avatar_id <span class="token operator">=</span> avatar<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span>creator_id <span class="token operator">=</span> ?<span class="token punctuation">)</span>
</code></pre></div><h3 id="execution"><a href="#execution" aria-hidden="true" class="header-anchor">#</a> Execution</h3> <p>If you have simple query without JOIN clauses you can use <code>execute()</code> method which will execute query and return result.</p> <p>For example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> repo
  <span class="token punctuation">.</span><span class="token function">startQuery</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> post <span class="token keyword">of</span> posts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//Do something with post</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In case of complex query with includes you can use some sort of magic to receive data in hierarchy format. For example let's execute our example from previous steps:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> postsWithCreatorsAndAvatars <span class="token operator">=</span> <span class="token keyword">await</span> query
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id = ?'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> post <span class="token keyword">of</span> postsWithCreatorsAndAvatars<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    title<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span>
    creator_id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    creator<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      login<span class="token punctuation">:</span> <span class="token string">'some'</span><span class="token punctuation">,</span>
      avatar_id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
      avatar<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// OR null if there's no avatar set</span>
        id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        path<span class="token punctuation">:</span> <span class="token string">'some'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So as you can see minorm follows the way that you used to describe your relations in a query.</p> <p>If you don't need to use this data in hierarchy way you can also use this mechanism:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> postRow <span class="token keyword">of</span> posts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> post<span class="token punctuation">,</span> creator<span class="token punctuation">,</span> avatar <span class="token punctuation">}</span> <span class="token operator">=</span> postRow
  <span class="token function">expect</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    title<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span>
    creator_id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>creator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    login<span class="token punctuation">:</span> <span class="token string">'some'</span><span class="token punctuation">,</span>
    avatar_id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>avatar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token string">'some'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Please note that in this case when there's no any record from <code>LEFT JOIN</code> it will return object with all columns with <code>null</code> values. So in this example it's wrong to check <code>if (avatar !== null)</code> because it will be always an object.</p> <p>Please also note that if you have some calculations in your query it will result as a object with key <code>''</code>. So for example you added calculation for count. To access it you will need to use:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> count <span class="token punctuation">}</span> <span class="token operator">=</span> postRow<span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span>
</code></pre></div><p>This is limitation of <code>mysql2</code></p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/minorm/guide/models.html" class="prev">
          Models
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/minorm/assets/js/app.202f15e2.js" defer></script><script src="/minorm/assets/js/8.c8257104.js" defer></script>
  </body>
</html>
